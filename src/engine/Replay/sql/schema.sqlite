-- Replay Database Schema for BarcodeRevealTool

-- Main replays table storing game information
CREATE TABLE IF NOT EXISTS Replays (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ReplayGuid TEXT NOT NULL UNIQUE,
    Player1 TEXT NOT NULL,
    Player2 TEXT NOT NULL,
    Player1Id TEXT,
    Player2Id TEXT,
    Map TEXT NOT NULL,
    Race1 TEXT NOT NULL,
    Race2 TEXT NOT NULL,
    GameDate TEXT NOT NULL,
    ReplayFilePath TEXT NOT NULL UNIQUE,
    FileHash TEXT NOT NULL,
    SC2ClientVersion TEXT,
    BuildOrderCached INTEGER DEFAULT 0,
    CachedAt TEXT,
    CreatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Build order entries table
CREATE TABLE IF NOT EXISTS BuildOrderEntries (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ReplayId INTEGER NOT NULL,
    PlayerId INTEGER NOT NULL,
    TimeSeconds REAL NOT NULL,
    Kind TEXT NOT NULL,
    Name TEXT NOT NULL,
    FOREIGN KEY (ReplayId) REFERENCES Replays(Id) ON DELETE CASCADE
);

-- Indexes for fast lookups
CREATE INDEX IF NOT EXISTS idx_Replays_ReplayGuid ON Replays(ReplayGuid);
CREATE INDEX IF NOT EXISTS idx_Replays_Player1 ON Replays(Player1);
CREATE INDEX IF NOT EXISTS idx_Replays_Player2 ON Replays(Player2);
CREATE INDEX IF NOT EXISTS idx_Replays_Player1Id ON Replays(Player1Id);
CREATE INDEX IF NOT EXISTS idx_Replays_Player2Id ON Replays(Player2Id);
CREATE INDEX IF NOT EXISTS idx_Replays_Map ON Replays(Map);
CREATE INDEX IF NOT EXISTS idx_Replays_GameDate ON Replays(GameDate);
CREATE INDEX IF NOT EXISTS idx_Replays_ReplayFilePath ON Replays(ReplayFilePath);
CREATE INDEX IF NOT EXISTS idx_Replays_BuildOrderCached ON Replays(BuildOrderCached);
CREATE INDEX IF NOT EXISTS idx_Replays_SC2ClientVersion ON Replays(SC2ClientVersion);
CREATE INDEX IF NOT EXISTS idx_BuildOrderEntries_ReplayId ON BuildOrderEntries(ReplayId);
CREATE INDEX IF NOT EXISTS idx_BuildOrderEntries_PlayerId ON BuildOrderEntries(PlayerId);

-- View for easy player vs player lookups
CREATE VIEW IF NOT EXISTS ReplaysByPlayers AS
SELECT 
    r.Id,
    r.ReplayGuid,
    r.Player1,
    r.Player2,
    r.Map,
    r.Race1,
    r.Race2,
    r.GameDate,
    r.ReplayFilePath,
    r.SC2ClientVersion,
    r.BuildOrderCached,
    COUNT(b.Id) as BuildOrderEntryCount
FROM Replays r
LEFT JOIN BuildOrderEntries b ON r.Id = b.ReplayId
GROUP BY r.Id;
