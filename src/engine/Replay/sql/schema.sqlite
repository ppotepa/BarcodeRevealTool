-- Replay Database Schema for BarcodeRevealTool

-- Main replays table storing game information
CREATE TABLE IF NOT EXISTS Replays (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ReplayGuid TEXT NOT NULL UNIQUE,
    You TEXT NOT NULL,
    Opponent TEXT NOT NULL,
    YouId TEXT,
    OpponentId TEXT,
    Map TEXT NOT NULL,
    YourRace TEXT NOT NULL,
    OpponentRace TEXT NOT NULL,
    GameDate TEXT NOT NULL,
    ReplayFilePath TEXT NOT NULL UNIQUE,
    FileHash TEXT NOT NULL,
    SC2ClientVersion TEXT,
    Winner TEXT,
    BuildOrderCached INTEGER DEFAULT 0,
    CachedAt TEXT,
    CreatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Build order entries table
CREATE TABLE IF NOT EXISTS BuildOrderEntries (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ReplayId INTEGER NOT NULL,
    PlayerId INTEGER NOT NULL,
    TimeSeconds REAL NOT NULL,
    Kind TEXT NOT NULL,
    Name TEXT NOT NULL,
    FOREIGN KEY (ReplayId) REFERENCES Replays(Id) ON DELETE CASCADE
);

-- Configuration metadata table for tracking config changes
CREATE TABLE IF NOT EXISTS ConfigMetadata (
    Id INTEGER PRIMARY KEY CHECK (Id = 1),
    ReplayFolderPath TEXT,
    RecursiveScan INTEGER DEFAULT 1,
    ConfigHash TEXT NOT NULL,
    LastValidated TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Opponents table for storing player information and toon handles
CREATE TABLE IF NOT EXISTS Opponents (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL UNIQUE,
    DisplayName TEXT NOT NULL,
    NickName TEXT NOT NULL DEFAULT '',
    ToonHandle TEXT,
    BattleTag TEXT NOT NULL,
    NormalizedBattleTag TEXT NOT NULL DEFAULT '',
    FirstSeen TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    LastSeen TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- User accounts table for storing discovered SC2 accounts
CREATE TABLE IF NOT EXISTS UserAccounts (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ToonHandle TEXT NOT NULL UNIQUE,
    NickName TEXT,
    BattleTag TEXT NOT NULL,
    Region INTEGER NOT NULL,
    Realm INTEGER NOT NULL,
    BattleNetId TEXT NOT NULL,
    DiscoveredAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for fast lookups
CREATE INDEX IF NOT EXISTS idx_Replays_ReplayGuid ON Replays(ReplayGuid);
CREATE INDEX IF NOT EXISTS idx_Replays_You ON Replays(You);
CREATE INDEX IF NOT EXISTS idx_Replays_Opponent ON Replays(Opponent);
CREATE INDEX IF NOT EXISTS idx_Replays_YouId ON Replays(YouId);
CREATE INDEX IF NOT EXISTS idx_Replays_OpponentId ON Replays(OpponentId);
CREATE INDEX IF NOT EXISTS idx_Replays_Map ON Replays(Map);
CREATE INDEX IF NOT EXISTS idx_Replays_GameDate ON Replays(GameDate);
CREATE INDEX IF NOT EXISTS idx_Replays_ReplayFilePath ON Replays(ReplayFilePath);
CREATE INDEX IF NOT EXISTS idx_Replays_BuildOrderCached ON Replays(BuildOrderCached);
CREATE INDEX IF NOT EXISTS idx_Replays_SC2ClientVersion ON Replays(SC2ClientVersion);
CREATE INDEX IF NOT EXISTS idx_BuildOrderEntries_ReplayId ON BuildOrderEntries(ReplayId);
CREATE INDEX IF NOT EXISTS idx_BuildOrderEntries_PlayerId ON BuildOrderEntries(PlayerId);
CREATE INDEX IF NOT EXISTS idx_Opponents_Name ON Opponents(Name);
CREATE INDEX IF NOT EXISTS idx_Opponents_DisplayName ON Opponents(DisplayName);
CREATE INDEX IF NOT EXISTS idx_Opponents_NickName ON Opponents(NickName);
CREATE INDEX IF NOT EXISTS idx_Opponents_ToonHandle ON Opponents(ToonHandle);
CREATE INDEX IF NOT EXISTS idx_Opponents_BattleTag ON Opponents(BattleTag);
CREATE INDEX IF NOT EXISTS idx_Opponents_NormalizedBattleTag ON Opponents(NormalizedBattleTag);
CREATE INDEX IF NOT EXISTS idx_UserAccounts_ToonHandle ON UserAccounts(ToonHandle);
CREATE INDEX IF NOT EXISTS idx_UserAccounts_Region ON UserAccounts(Region);
CREATE INDEX IF NOT EXISTS idx_UserAccounts_NickName ON UserAccounts(NickName);

-- Note: ALTER TABLE ADD COLUMN statements are handled in code for compatibility with older SQLite versions
-- Backwards-compatibility migrations are applied programmatically in ReplayDatabase.cs

-- View for easy player vs player lookups
CREATE VIEW IF NOT EXISTS ReplaysByPlayers AS
SELECT 
    r.Id,
    r.ReplayGuid,
    r.You,
    r.Opponent,
    r.Map,
    r.YourRace,
    r.OpponentRace,
    r.GameDate,
    r.ReplayFilePath,
    r.SC2ClientVersion,
    r.BuildOrderCached,
    COUNT(b.Id) as BuildOrderEntryCount
FROM Replays r
LEFT JOIN BuildOrderEntries b ON r.Id = b.ReplayId
GROUP BY r.Id;
